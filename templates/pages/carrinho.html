<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RCL</title>
  <link rel="stylesheet" href="../../static/css/styles.css">
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
</head>
<body class="body1">
  {% include 'components/header.html' %}

  <main class="carrinho-container">
    <h1 class="carrinho-titulo">Seu Carrinho</h1>
    
    <div class="produtos-lista">
      <!-- aqui o js preenche -->
    </div>
    
    <div class="carrinho-footer">
      <div class="resumo-carrinho">
        <div class="total-info">
          <span class="total-itens" id="totalItens">
            Total de itens: {{ total_itens }}
          </span>
          <span class="subtotal" id="subtotal">
            Subtotal: R$ {{ "%.2f"|format(subtotal) }}
          </span>


        <!-- Botão com estilo antigo, mas redireciona corretamente -->
        <button class="btn-continuar" onclick="window.location.href='{{ url_for('compra') }}'">
          Continuar
        </button>
      </div>
    </div>
  </main>

  {% set id = 'carrinhoFooter' %}
  {% include "components/footer.html" with context %}
</body>
<script src="{{ url_for('static', filename='js/carrinho.js') }}"></script>

<script>
function diminuirQuantidade(produtoId) {
  const input = document.getElementById(`qtd${produtoId}`);
  if (input.value > 1) {
    input.value--;
    atualizarPreco(produtoId);
  }
}

function aumentarQuantidade(produtoId) {
  const input = document.getElementById(`qtd${produtoId}`);
  input.value++;
  atualizarPreco(produtoId);
}

function atualizarPreco(produtoId) {
  const quantidade = parseInt(document.getElementById(`qtd${produtoId}`).value);
  const precoTotal = quantidade * 22;
  
  document.getElementById(`preco${produtoId}`).textContent = `R$ ${precoTotal.toFixed(2).replace('.', ',')}`;
  atualizarTotalCarrinho();
}

async function removerProduto(produtoId) {
  try {
    const compradorId = localStorage.getItem("compradorId");
    if (!compradorId) {
      alert("Você precisa estar logado para remover itens do carrinho.");
      return;
    }

    const resp = await fetch("/removerDoCarrinho", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ id_comprador: compradorId, id_produto: produtoId })
    });

    const json = await resp.json();
    if (!resp.ok || (json && json.status !== "ok")) {
      console.error("Erro ao remover:", json);
      alert("Não foi possível remover o item.");
      return;
    }

    // só remove do DOM se o banco confirmou
    const produto = document.getElementById(`produto${produtoId}`);
    if (produto) produto.remove();
    atualizarTotalCarrinho();

  } catch (e) {
    console.error(e);
    alert("Erro ao comunicar com o servidor.");
  }
}

function atualizarTotalCarrinho() {
  const produtos = document.querySelectorAll('.produto-item');
  let total = 0;
  let totalItens = 0;
  
  produtos.forEach(produto => {
    const checkbox = produto.querySelector('input[type="checkbox"]');
    if (checkbox && checkbox.checked) {
      const quantidade = parseInt(produto.querySelector('.quantidade-input').value);
      total += quantidade * 22;
      totalItens += quantidade;
    }
  });
  
  document.getElementById('totalItens').textContent = `Total de itens: ${totalItens}`;
  document.getElementById('subtotal').textContent = `Subtotal: R$ ${total.toFixed(2).replace('.', ',')}`;
}

document.addEventListener('change', function(e) {
  if (e.target.type === 'checkbox' && e.target.closest('.produto-item')) {
    atualizarTotalCarrinho();
  }
});
</script>
</html>
