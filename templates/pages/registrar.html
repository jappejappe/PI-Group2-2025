<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RCL</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>
<body>
    <div id="registrarBody">
        {% include "components/header.html" with context %}
        <form id="registrarForm" method="post" action="/registrar">
            <h2>Registrar-se</h2>
    
            <div class="form-item">
                <label for="nome">Nome Completo</label>
                <input type="text" id="nome" name="nome" placeholder="Usuário" />
            </div>
            <div class="form-item">
                <label for="username">Nome de Usuário</label>
                <input type="text" id="username" name="username" placeholder="@username" />
            </div>
            <div class="form-item">
                <label for="email">E-Mail</label>
                <input type="email" id="email" name="email" placeholder="exemplo@dominio.com" />
            </div>
            <div class="form-item">
                <label for="nascimento">Nascimento</label>
                <input type="text" id="nascimento" name="nascimento" placeholder="DD/MM/YYYY" />
            </div>
            <div class="form-item">
                <label for="cep">CEP</label>
                <input type="text" id="cep" name="cep" placeholder="99999-999" />
            </div>
            <div class="form-item">
                <label for="cpf">CPF</label>
                <input type="text" id="cpf" name="cpf" placeholder="999.999.999-99" />
            </div>
            <div class="form-item">
                <label for="password">Senha</label>
                <input type="password" id="password" name="password" placeholder="Senha" />
                <p class="password-hint">Mínimo de 8 caracteres, contendo ao menos um número.</p>
            </div>
            <div id="registrarBotoes">
                <!-- botao continuar -->
                {% set corBotao = 'black' %}
                {% set textoBotao = 'Registrar' %}
                {% set id = 'registrarButton' %}
                {% include "components/buttonDados.html" with context %}

                <!-- botao fazer login -->
                {% set corBotao = 'white' %}
                {% set textoBotao = 'Fazer Login' %}
                {% set path = 'login' %}
                {% include "components/button.html" with context %}
            </div>
        </form>
        {% set id = 'registrarFooter' %}
        {% include "components/footer.html" with context %}
    </div>
</body>
<script src="../../static/js/registrar.js" ></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', () => {

    // utilitários para preservar posição do cursor por índice de dígitos
    function digitIndexFromPos(val, pos) {
        let count = 0;
        for (let i = 0; i < pos; i++) if (/\d/.test(val[i])) count++;
        return count;
    }
    function setCursorByDigitIndex(input, digitIndex) {
        const val = input.value;
        let digitsSeen = 0;
        for (let i = 0; i < val.length; i++) {
        if (/\d/.test(val[i])) digitsSeen++;
        if (digitsSeen === digitIndex) { input.setSelectionRange(i + 1, i + 1); return; }
        }
        input.setSelectionRange(val.length, val.length);
    }

    // formatadores
    function formatCEP(raw) {
        const d = raw.replace(/\D/g, '').slice(0,8);
        if (d.length <= 5) return d;
        return d.slice(0,5) + '-' + d.slice(5);
    }

    function formatCPF(raw) {
        const d = raw.replace(/\D/g, '').slice(0,11);
        const p1 = d.slice(0,3), p2 = d.slice(3,6), p3 = d.slice(6,9), p4 = d.slice(9,11);
        let out = p1;
        if (p2) out += '.' + p2;
        if (p3) out += '.' + p3;
        if (p4) out += '-' + p4;
        return out;
    }

    function formatDate(raw) {
        const d = raw.replace(/\D/g, '').slice(0,8);
        const dd = d.slice(0,2), mm = d.slice(2,4), yy = d.slice(4,8);
        let out = '';
        if (dd) out += dd;
        if (mm) out += '/' + mm;
        if (yy) out += '/' + yy;
        return out;
    }

    // anexa máscara a um input pelo seletor
    function attachMask(selector, formatter) {
        const input = document.querySelector(selector);
        if (!input) return;
        input.addEventListener('input', function (e) {
        const oldVal = input.value;
        const oldPos = input.selectionStart;
        const digitIndex = digitIndexFromPos(oldVal, oldPos);
        const newVal = formatter(oldVal);
        input.value = newVal;
        setCursorByDigitIndex(input, digitIndex);
        });

        // também no paste (para formatar o conteúdo colado)
        input.addEventListener('paste', function () {
        setTimeout(() => { // wait for paste to populate
            input.value = formatter(input.value);
        }, 0);
        });
    }

    attachMask('#cep', formatCEP);
    attachMask('#cpf', formatCPF);
    attachMask('#nascimento', formatDate);
    // attachMask('#telefone', formatPhone); // se existir, implemente formatPhone similar

    // limpeza antes de enviar
    const form = document.getElementById('registrarForm');
    if (form) {
        form.addEventListener('submit', function () {
        const onlyDigits = v => v ? v.replace(/\D/g, '') : '';
        ['cep','cpf','telefone'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.value = onlyDigits(el.value);
        });
        const nasc = document.getElementById('nascimento');
        if (nasc) {
            const m = nasc.value.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
            if (m) nasc.value = `${m[3]}-${m[2]}-${m[1]}`;
        }
        });
    }
    });
    </script>
</html>